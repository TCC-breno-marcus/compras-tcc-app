name: CI - Testes

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Testes do backend (.NET)
        run: |
          dotnet restore backend/backend.sln
          dotnet test backend/backend.sln --configuration Release --no-restore

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Instalar dependências do frontend
        working-directory: frontend
        run: npm ci

      - name: Instalar provider de coverage do Vitest (CI)
        working-directory: frontend
        run: npm i -D @vitest/coverage-v8@3.2.4 --no-save

      - name: Testes unitários do frontend com coverage (Vitest)
        working-directory: frontend
        run: npm run test:unit:coverage

      - name: Gerar resumo de coverage no job
        if: always()
        working-directory: frontend
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            node -e "
            const fs=require('fs');
            const s=JSON.parse(fs.readFileSync('coverage/coverage-summary.json','utf8')).total;
            const out = [
              '## Cobertura de Testes Unitários (Vitest)',
              '',
              '| Métrica | Percentual |',
              '|---|---:|',
              '| Linhas | '+s.lines.pct+'% |',
              '| Funções | '+s.functions.pct+'% |',
              '| Statements | '+s.statements.pct+'% |',
              '| Branches | '+s.branches.pct+'% |',
              '',
            ].join('\n');
            fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, out);
            "
          else
            echo "Resumo de coverage não encontrado." >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Publicar artefato de coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-report
          path: |
            frontend/coverage
          if-no-files-found: warn
          retention-days: 14

      - name: Criar .env para stack de E2E no CI
        run: |
          cat > .env << 'EOF'
          DB_USER=postgres
          DB_PASSWORD=postgres
          DB_NAME=compras_db
          ASPNETCORE_ENVIRONMENT=Development
          JWT_KEY=chave-super-secreta-para-ci-com-32-bytes
          JWT_ISSUER=compras-tcc-ci
          JWT_AUDIENCE=compras-tcc-ci
          EOF

      - name: Subir stack para E2E
        run: docker compose up -d --build postgres-db backend-service frontend-service cypress

      - name: Aguardar frontend no ar
        run: |
          for i in {1..60}; do
            if curl -sSf http://localhost:5173 > /dev/null; then
              exit 0
            fi
            sleep 5
          done
          echo "Frontend não ficou disponível a tempo"
          exit 1

      - name: Aguardar backend no ar
        run: |
          for i in {1..60}; do
            if (echo > /dev/tcp/127.0.0.1/5000) >/dev/null 2>&1; then
              exit 0
            fi
            sleep 5
          done
          echo "Backend não ficou disponível a tempo"
          exit 1

      - name: Instalar dependências no container Cypress
        run: docker compose exec -T cypress npm ci

      - name: Rodar testes E2E (Cypress)
        run: docker compose exec -T cypress npx cypress run --e2e

      - name: Encerrar stack de E2E
        if: always()
        run: docker compose down -v

